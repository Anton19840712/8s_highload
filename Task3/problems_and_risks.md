# Анализ проблем и рисков текущей архитектуры InsureTech

## 1. Синхронное взаимодействие между сервисами

### Проблема
Сервисы core-app и ins-comp-settlement получают данные о продуктах через синхронные REST-вызовы к ins-product-aggregator. В момент вызова ins-product-aggregator синхронно опрашивает все 5 страховых компаний и агрегирует ответы.

### Риски при росте нагрузки
- **Увеличение количества страховых компаний с 5 до 10** кратно увеличит время ответа ins-product-aggregator, так как он ждёт ответа от каждой компании.
- **Каскадные сбои**: если одна из страховых компаний отвечает медленно или недоступна, это блокирует весь ответ ins-product-aggregator, а через него — core-app и ins-comp-settlement.
- **Временная связанность (temporal coupling)**: все сервисы в цепочке должны быть доступны одновременно для успешной обработки запроса.

## 2. Периодический polling данных

### Проблема
core-app опрашивает ins-product-aggregator каждые 15 минут, ins-comp-settlement — раз в сутки. Данные о продуктах и тарифах могут быть неактуальны до 15 минут.

### Риски
- **Неактуальность данных**: клиент может видеть устаревшие тарифы.
- **Избыточная нагрузка**: polling выполняется даже если данные не менялись.
- **Пиковая нагрузка**: ins-comp-settlement ночью запрашивает все данные за день через REST — при росте объёмов это может приводить к таймаутам.

## 3. Двойная запись (dual write)

### Проблема
При оформлении страховки core-app записывает данные в свою БД и должен обеспечить, чтобы ins-comp-settlement получил эти данные. Сейчас ins-comp-settlement забирает данные по REST раз в сутки.

### Риски
- **Потеря данных**: если запрос ins-comp-settlement к core-app упадёт, данные об оформленных страховках не попадут в реестр для страховых компаний.
- **Нарушение целостности**: нет гарантии, что все оформленные страховки будут учтены при взаиморасчётах.

## 4. Отсутствие асинхронного слоя обмена сообщениями

### Проблема
Вся коммуникация между сервисами — синхронная (REST). Нет брокера сообщений.

### Риски
- **Невозможность масштабирования**: при росте числа страховых компаний и пользователей синхронная архитектура станет узким горлышком.
- **Сложность добавления новых потребителей**: каждый новый сервис, которому нужны данные, создаёт дополнительную нагрузку на поставщика.
- **Отсутствие буферизации**: при всплесках нагрузки нет возможности сглаживать поток запросов.

## 5. Риски при подключении 5 новых страховых компаний

### Проблема
Планируется рост количества интеграций с 5 до 10.

### Риски
- **Время ответа ins-product-aggregator увеличится пропорционально** количеству вызываемых компаний.
- **Вероятность сбоя возрастает**: больше внешних зависимостей — выше вероятность, что хотя бы одна из них недоступна.
- **Нет паттернов отказоустойчивости**: отсутствуют Circuit Breaker, Timeout, Retry при вызовах внешних API.

## Предлагаемые решения

1. **Внедрить Apache Kafka** как брокер сообщений для асинхронного обмена данными между сервисами.
2. **Перевести обновление данных о продуктах на Event-Streaming**: ins-product-aggregator публикует события об изменении продуктов/тарифов в Kafka, core-app и ins-comp-settlement подписываются и обновляют свои локальные реплики.
3. **Перевести передачу оформленных страховок на события**: core-app публикует событие InsurancePolicyCreated в Kafka, ins-comp-settlement подписывается.
4. **Применить Transactional Outbox** в core-app для гарантии доставки событий о новых страховках.
5. **Добавить паттерны отказоустойчивости** (Circuit Breaker, Timeout, Retry) при вызовах внешних API страховых компаний.
